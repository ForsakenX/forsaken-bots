#!/usr/bin/env ruby

# root directory
ROOT = File.dirname(__FILE__)
puts "ROOT: '#{ROOT}'"

# user distribution
DIST = "#{ROOT}/dist"
puts "DIST: '#{DIST}'"

# load event machine
require 'rubygems'
require "#{ROOT}/lib/eventmachine-0.9.0/lib/eventmachine"
puts "EventMachine Loaded"

# meth name space
require "#{ROOT}/lib/meth.rb"
puts "Meth Loaded"

# load configs
require 'yaml'
$config = YAML.load(File.open("#{DIST}/conf/methbot.yaml"))
puts "Loaded methobot.yaml"

# loggin facility
require 'logger'
$logger = Logger.new("#{DIST}/logs/#{$config['logger']['file']}",$config['logger']['rotate'])
$logger.level = Logger.get_const($config['logger']['severity'])
puts "Setup Logger"

# CAN WE USE EM FILE WRITING FOR LOGGING?
EM.epoll
EM.run {
  # load up user init.rb
  require "#{DIST}/conf/init"
  # load up the bots
  $config["bots"].each do |config|
    begin
      bot = Meth::Bot.new(config)
      puts "Connecting #{bot.name} to #{bot.server}:#{bot.port}"
      EM::connect(bot.server, bot.port, bot)
    rescue
      puts "Error: #{$!}"
      $@.each do |line| puts "#{line}" end
    end
  end
}

# close file descriptors
$logger.close

