#!/usr/bin/env ruby

##
# Settings
##

# root directory
ROOT = File.dirname(__FILE__)
puts "ROOT: '#{ROOT}'"

# set load path
$: << "#{ROOT}/lib/"

# user distribution
DIST = "#{ROOT}/dist"
puts "DIST: '#{DIST}'"

# load user configs
require 'yaml'
$config = YAML.load(File.open("#{DIST}/conf/methbot.yaml"))
puts "Loaded methobot.yaml"

##
# Main Libs
##

# load event machine
require 'rubygems'
require "eventmachine-0.9.0/lib/eventmachine"
puts "EventMachine Loaded"

# meth name space
require "meth/meth.rb"
puts "Meth Loaded"

##
# Global Logging
#   CAN WE USE EM FILE WRITING FOR LOGGING?
##

# loggin facility
require 'logger'
if $config['logger']['console']
  $logger = Logger.new(STDOUT)
else
  $logger = Logger.new("#{DIST}/logs/#{$config['logger']['file']}",$config['logger']['rotate'])
end
$logger.level = Logger.const_get($config['logger']['severity'])
puts "Setup Logger"

##
#  Global Events
##

$event = Meth::Event.new($logger)

##
# Run
##

EM.epoll
EM.run {
  # load up user init.rb
  require "#{DIST}/conf/init"
  # load up the bots
  $config["bots"].each do |config|
    begin
      Meth::Bot.new(config)
    rescue
      puts "Error: #{$!}"
      $@.each do |line| puts "#{line}" end
    end
  end
}

##
# Cleanup
##

# close file descriptors
$logger.close

